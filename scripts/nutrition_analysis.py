#!/usr/bin/env python3
"""
Nutrition & Metabolism Analysis Script
Analyzes nutrition-related genetic markers from 23andMe data
"""

import os
from datetime import datetime
from collections import defaultdict

# Paths
BASE_PATH = "/Users/sh/Library/Mobile Documents/com~apple~CloudDocs/dna"
GENOME_FILE = f"{BASE_PATH}/data/genome_Andre_Sh_v5_Full_20260106100611.txt"
REPORTS_PATH = f"{BASE_PATH}/reports"

# =============================================================================
# SNP DATABASE - Nutrition markers
# =============================================================================

NUTRITION_SNPS = {
    "lactose": {
        "name": "–õ–∞–∫—Ç–æ–∑–∞",
        "snps": {
            "rs4988235": {
                "gene": "LCT (MCM6)",
                "description": "–ü–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å –ª–∞–∫—Ç–æ–∑—ã",
                "interpretation": {
                    "TT": ("tolerant", "–ü–µ—Ä–µ–Ω–æ—Å–∏—Ç –ª–∞–∫—Ç–æ–∑—É (–ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ü–∏—è –ª–∞–∫—Ç–∞–∑—ã)"),
                    "CT": ("partial", "–ß–∞—Å—Ç–∏—á–Ω–∞—è –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å"),
                    "CC": ("intolerant", "–ù–µ–ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å –ª–∞–∫—Ç–æ–∑—ã"),
                    "AA": ("tolerant", "–ü–µ—Ä–µ–Ω–æ—Å–∏—Ç –ª–∞–∫—Ç–æ–∑—É"),
                    "AG": ("partial", "–ß–∞—Å—Ç–∏—á–Ω–∞—è –ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å"),
                    "GG": ("intolerant", "–ù–µ–ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å –ª–∞–∫—Ç–æ–∑—ã"),
                }
            },
        }
    },

    "gluten": {
        "name": "–ì–ª—é—Ç–µ–Ω (—Ü–µ–ª–∏–∞–∫–∏—è)",
        "snps": {
            "rs2187668": {
                "gene": "HLA-DQ2.5",
                "description": "–†–∏—Å–∫ —Ü–µ–ª–∏–∞–∫–∏–∏",
                "interpretation": {
                    "TT": ("high_risk", "HLA-DQ2.5 - –≤—ã—Å–æ–∫–∏–π –≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫ —Ü–µ–ª–∏–∞–∫–∏–∏"),
                    "CT": ("moderate_risk", "–ù–æ—Å–∏—Ç–µ–ª—å HLA-DQ2.5 - —É–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫"),
                    "CC": ("low_risk", "–ù–∏–∑–∫–∏–π –≥–µ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π —Ä–∏—Å–∫ —Ü–µ–ª–∏–∞–∫–∏–∏"),
                }
            },
            "rs7454108": {
                "gene": "HLA-DQ8",
                "description": "–†–∏—Å–∫ —Ü–µ–ª–∏–∞–∫–∏–∏",
                "interpretation": {
                    "CC": ("moderate_risk", "HLA-DQ8 - —É–º–µ—Ä–µ–Ω–Ω—ã–π —Ä–∏—Å–∫ —Ü–µ–ª–∏–∞–∫–∏–∏"),
                    "CT": ("low_risk", "–ù–æ—Å–∏—Ç–µ–ª—å"),
                    "TT": ("low_risk", "–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫"),
                }
            },
        }
    },

    "caffeine": {
        "name": "–ö–æ—Ñ–µ–∏–Ω",
        "snps": {
            "rs762551": {
                "gene": "CYP1A2",
                "description": "–ú–µ—Ç–∞–±–æ–ª–∏–∑–º –∫–æ—Ñ–µ–∏–Ω–∞",
                "interpretation": {
                    "AA": ("fast", "–ë—ã—Å—Ç—Ä—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–∞—Ç–æ—Ä - –∫–æ—Ñ–µ–∏–Ω –±–µ–∑–æ–ø–∞—Å–µ–Ω –¥–æ 400–º–≥/–¥–µ–Ω—å"),
                    "AC": ("medium", "–°—Ä–µ–¥–Ω–∏–π –º–µ—Ç–∞–±–æ–ª–∏–∑–∞—Ç–æ—Ä - —É–º–µ—Ä–µ–Ω–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ"),
                    "CC": ("slow", "–ú–µ–¥–ª–µ–Ω–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–∞—Ç–æ—Ä - —Ä–∏—Å–∫ –¥–ª—è —Å–µ—Ä–¥—Ü–∞ –ø—Ä–∏ >200–º–≥/–¥–µ–Ω—å"),
                }
            },
            "rs5751876": {
                "gene": "ADORA2A",
                "description": "–¢—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å –æ—Ç –∫–æ—Ñ–µ–∏–Ω–∞",
                "interpretation": {
                    "TT": ("low_anxiety", "–ú–µ–Ω—å—à–µ —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç –∫–æ—Ñ–µ–∏–Ω–∞"),
                    "CT": ("moderate_anxiety", "–£–º–µ—Ä–µ–Ω–Ω–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å"),
                    "CC": ("high_anxiety", "–ë–æ–ª—å—à–µ —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç–∏ –æ—Ç –∫–æ—Ñ–µ–∏–Ω–∞"),
                }
            },
        }
    },

    "alcohol": {
        "name": "–ê–ª–∫–æ–≥–æ–ª—å",
        "snps": {
            "rs671": {
                "gene": "ALDH2",
                "description": "–ú–µ—Ç–∞–±–æ–ª–∏–∑–º –∞–ª–∫–æ–≥–æ–ª—è (–∞–∑–∏–∞—Ç—Å–∫–∏–π —Ä—É–º—è–Ω–µ—Ü)",
                "interpretation": {
                    "GG": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º"),
                    "AG": ("flush", "Asian flush - –Ω–µ–ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å, —Ä–∏—Å–∫ —Ä–∞–∫–∞ –ø—Ä–∏ —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏"),
                    "AA": ("severe", "–°–∏–ª—å–Ω–∞—è –Ω–µ–ø–µ—Ä–µ–Ω–æ—Å–∏–º–æ—Å—Ç—å –∞–ª–∫–æ–≥–æ–ª—è"),
                }
            },
            "rs1229984": {
                "gene": "ADH1B",
                "description": "–°–∫–æ—Ä–æ—Å—Ç—å –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞ —ç—Ç–∞–Ω–æ–ª–∞",
                "interpretation": {
                    "CC": ("slow", "–ú–µ–¥–ª–µ–Ω–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º - –≤—ã—à–µ —Ä–∏—Å–∫ –∞–ª–∫–æ–≥–æ–ª–∏–∑–º–∞"),
                    "CT": ("fast", "–ë—ã—Å—Ç—Ä—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º - –∑–∞—â–∏—Ç–∞ –æ—Ç –∞–ª–∫–æ–≥–æ–ª–∏–∑–º–∞"),
                    "TT": ("fast", "–û—á–µ–Ω—å –±—ã—Å—Ç—Ä—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º - –∑–∞—â–∏—Ç–∞"),
                }
            },
        }
    },

    "vitamin_d": {
        "name": "–í–∏—Ç–∞–º–∏–Ω D",
        "snps": {
            "rs2282679": {
                "gene": "GC (VDBP)",
                "description": "–£—Ä–æ–≤–µ–Ω—å –≤–∏—Ç–∞–º–∏–Ω–∞ D –≤ –∫—Ä–æ–≤–∏",
                "interpretation": {
                    "CC": ("low", "–°–Ω–∏–∂–µ–Ω–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å –≤–∏—Ç–∞–º–∏–Ω–∞ D - –Ω—É–∂–Ω–∞ –¥–æ–±–∞–≤–∫–∞"),
                    "AC": ("moderate", "–£–º–µ—Ä–µ–Ω–Ω–æ —Å–Ω–∏–∂–µ–Ω - –∫–æ–Ω—Ç—Ä–æ–ª—å —É—Ä–æ–≤–Ω—è"),
                    "GT": ("moderate", "–£–º–µ—Ä–µ–Ω–Ω–æ —Å–Ω–∏–∂–µ–Ω"),
                    "AA": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å"),
                    "TT": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å"),
                    "GG": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å"),
                }
            },
            "rs7041": {
                "gene": "GC",
                "description": "–í–∏—Ç–∞–º–∏–Ω D —Å–≤—è–∑—ã–≤–∞—é—â–∏–π –±–µ–ª–æ–∫",
                "interpretation": {
                    "TT": ("low", "Gc1F - —Å–Ω–∏–∂–µ–Ω–Ω—ã–π –≤–∏—Ç–∞–º–∏–Ω D"),
                    "GT": ("moderate", "–£–º–µ—Ä–µ–Ω–Ω–æ —Å–Ω–∏–∂–µ–Ω"),
                    "AC": ("moderate", "–£–º–µ—Ä–µ–Ω–Ω–æ —Å–Ω–∏–∂–µ–Ω"),
                    "GG": ("normal", "Gc1S - –Ω–æ—Ä–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å"),
                    "AA": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å"),
                    "CC": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω—ã–π"),
                }
            },
            "rs12785878": {
                "gene": "DHCR7",
                "description": "–°–∏–Ω—Ç–µ–∑ –≤–∏—Ç–∞–º–∏–Ω–∞ D –æ—Ç —Å–æ–ª–Ω—Ü–∞",
                "interpretation": {
                    "TT": ("low", "–ú–µ–Ω—å—à–µ —Å–∏–Ω—Ç–µ–∑ –æ—Ç —Å–æ–ª–Ω—Ü–∞"),
                    "GT": ("moderate", "–£–º–µ—Ä–µ–Ω–Ω–æ —Å–Ω–∏–∂–µ–Ω —Å–∏–Ω—Ç–µ–∑"),
                    "GG": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω—ã–π —Å–∏–Ω—Ç–µ–∑"),
                }
            },
        }
    },

    "vitamin_b": {
        "name": "–í–∏—Ç–∞–º–∏–Ω—ã –≥—Ä—É–ø–ø—ã B",
        "snps": {
            "rs1801133": {
                "gene": "MTHFR C677T",
                "description": "–ú–µ—Ç–∞–±–æ–ª–∏–∑–º —Ñ–æ–ª–∞—Ç–æ–≤ (B9)",
                "interpretation": {
                    "TT": ("impaired", "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ~30% - –Ω—É–∂–µ–Ω –º–µ—Ç–∏–ª—Ñ–æ–ª–∞—Ç"),
                    "CT": ("moderate", "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ~65% - –º–µ—Ç–∏–ª—Ñ–æ–ª–∞—Ç –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª–µ–Ω"),
                    "AG": ("moderate", "–ê–∫—Ç–∏–≤–Ω–æ—Å—Ç—å ~65%"),
                    "CC": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å - —Ñ–æ–ª–∏–µ–≤–∞—è –∫–∏—Å–ª–æ—Ç–∞ OK"),
                    "AA": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"),
                }
            },
            "rs1801131": {
                "gene": "MTHFR A1298C",
                "description": "–ú–µ—Ç–∞–±–æ–ª–∏–∑–º —Ñ–æ–ª–∞—Ç–æ–≤",
                "interpretation": {
                    "CC": ("impaired", "–°–Ω–∏–∂–µ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"),
                    "AC": ("moderate", "–ù–µ–º–Ω–æ–≥–æ —Å–Ω–∏–∂–µ–Ω–∞"),
                    "GT": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"),
                    "AA": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω–∞—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å"),
                    "TT": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω–∞—è"),
                }
            },
            "rs602662": {
                "gene": "FUT2",
                "description": "–í—Å–∞—Å—ã–≤–∞–Ω–∏–µ –≤–∏—Ç–∞–º–∏–Ω–∞ B12",
                "interpretation": {
                    "AA": ("impaired", "–°–Ω–∏–∂–µ–Ω–Ω–æ–µ –≤—Å–∞—Å—ã–≤–∞–Ω–∏–µ B12 - –Ω—É–∂–Ω–∞ –¥–æ–±–∞–≤–∫–∞"),
                    "AG": ("moderate", "–£–º–µ—Ä–µ–Ω–Ω–æ —Å–Ω–∏–∂–µ–Ω–æ"),
                    "GG": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –≤—Å–∞—Å—ã–≤–∞–Ω–∏–µ"),
                }
            },
        }
    },

    "vitamin_a": {
        "name": "–í–∏—Ç–∞–º–∏–Ω A",
        "snps": {
            "rs12934922": {
                "gene": "BCMO1",
                "description": "–ö–æ–Ω–≤–µ—Ä—Å–∏—è –±–µ—Ç–∞-–∫–∞—Ä–æ—Ç–∏–Ω–∞ –≤ –≤–∏—Ç–∞–º–∏–Ω A",
                "interpretation": {
                    "TT": ("impaired", "–ü–ª–æ—Ö–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è - –Ω—É–∂–µ–Ω –≥–æ—Ç–æ–≤—ã–π –≤–∏—Ç–∞–º–∏–Ω A (—Ä–µ—Ç–∏–Ω–æ–ª)"),
                    "AT": ("moderate", "–£–º–µ—Ä–µ–Ω–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è"),
                    "AA": ("normal", "–•–æ—Ä–æ—à–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è –±–µ—Ç–∞-–∫–∞—Ä–æ—Ç–∏–Ω–∞"),
                }
            },
            "rs7501331": {
                "gene": "BCMO1",
                "description": "–ö–æ–Ω–≤–µ—Ä—Å–∏—è –±–µ—Ç–∞-–∫–∞—Ä–æ—Ç–∏–Ω–∞",
                "interpretation": {
                    "TT": ("impaired", "–ü–ª–æ—Ö–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è"),
                    "CT": ("moderate", "–£–º–µ—Ä–µ–Ω–Ω–∞—è"),
                    "CC": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è"),
                }
            },
        }
    },

    "omega3": {
        "name": "–û–º–µ–≥–∞-3 –∂–∏—Ä–Ω—ã–µ –∫–∏—Å–ª–æ—Ç—ã",
        "snps": {
            "rs174546": {
                "gene": "FADS1",
                "description": "–ö–æ–Ω–≤–µ—Ä—Å–∏—è ALA –≤ EPA/DHA",
                "interpretation": {
                    "TT": ("impaired", "–ü–ª–æ—Ö–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è - –Ω—É–∂–Ω—ã –≥–æ—Ç–æ–≤—ã–µ EPA/DHA (—Ä—ã–±–∞, –¥–æ–±–∞–≤–∫–∏)"),
                    "CT": ("moderate", "–£–º–µ—Ä–µ–Ω–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è"),
                    "CC": ("normal", "–•–æ—Ä–æ—à–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è –∏–∑ —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤"),
                }
            },
            "rs174547": {
                "gene": "FADS1",
                "description": "–ú–µ—Ç–∞–±–æ–ª–∏–∑–º –æ–º–µ–≥–∞-3",
                "interpretation": {
                    "TT": ("impaired", "–°–Ω–∏–∂–µ–Ω–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è"),
                    "CT": ("moderate", "–£–º–µ—Ä–µ–Ω–Ω–∞—è"),
                    "CC": ("normal", "–•–æ—Ä–æ—à–∞—è –∫–æ–Ω–≤–µ—Ä—Å–∏—è"),
                }
            },
        }
    },

    "salt": {
        "name": "–°–æ–ª—å –∏ –¥–∞–≤–ª–µ–Ω–∏–µ",
        "snps": {
            "rs4961": {
                "gene": "ADD1",
                "description": "–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ —Å–æ–ª–∏",
                "interpretation": {
                    "TT": ("sensitive", "–°–æ–ª—å-—á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–∞—è –≥–∏–ø–µ—Ä—Ç–æ–Ω–∏—è - –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Å–æ–ª—å"),
                    "GT": ("moderate", "–£–º–µ—Ä–µ–Ω–Ω–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å"),
                    "GG": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ —Å–æ–ª–∏"),
                }
            },
            "rs699": {
                "gene": "AGT",
                "description": "–ê–Ω–≥–∏–æ—Ç–µ–Ω–∑–∏–Ω–æ–≥–µ–Ω",
                "interpretation": {
                    "CC": ("sensitive", "–ü–æ–≤—ã—à–µ–Ω–Ω–æ–µ –¥–∞–≤–ª–µ–Ω–∏–µ –æ—Ç —Å–æ–ª–∏"),
                    "CT": ("moderate", "–£–º–µ—Ä–µ–Ω–Ω–∞—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å"),
                    "TT": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω–∞—è —Ä–µ–∞–∫—Ü–∏—è –Ω–∞ —Å–æ–ª—å"),
                }
            },
        }
    },

    "taste": {
        "name": "–í–∫—É—Å–æ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏",
        "snps": {
            "rs713598": {
                "gene": "TAS2R38",
                "description": "–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –≥–æ—Ä–µ—á–∏",
                "interpretation": {
                    "GG": ("supertaster", "–°—É–ø–µ—Ä—Ç–∞—Å—Ç–µ—Ä - —Å–∏–ª—å–Ω–æ —á—É–≤—Å—Ç–≤—É–µ—Ç –≥–æ—Ä–µ—á—å (–±—Ä–æ–∫–∫–æ–ª–∏, –∫–æ—Ñ–µ)"),
                    "CG": ("medium", "–°—Ä–µ–¥–Ω—è—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∫ –≥–æ—Ä–µ—á–∏"),
                    "CC": ("non_taster", "–ù–µ —á—É–≤—Å—Ç–≤—É–µ—Ç –≥–æ—Ä–µ—á—å PROP/PTC"),
                }
            },
            "rs72921001": {
                "gene": "OR6A2",
                "description": "–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ –∫–æ—Ä–∏–∞–Ω–¥—Ä–∞",
                "interpretation": {
                    "AA": ("soap", "–ö–æ—Ä–∏–∞–Ω–¥—Ä –ø–∞—Ö–Ω–µ—Ç –º—ã–ª–æ–º"),
                    "AC": ("mild", "–°–ª–∞–±–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ –º—ã–ª—å–Ω–æ–≥–æ –≤–∫—É—Å–∞"),
                    "CC": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ –∫–æ—Ä–∏–∞–Ω–¥—Ä–∞"),
                }
            },
        }
    },

    "iron": {
        "name": "–ñ–µ–ª–µ–∑–æ",
        "snps": {
            "rs1800562": {
                "gene": "HFE C282Y",
                "description": "–ì–µ–º–æ—Ö—Ä–æ–º–∞—Ç–æ–∑ (–Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –∂–µ–ª–µ–∑–∞)",
                "interpretation": {
                    "AA": ("high_risk", "–ì–µ–º–æ—Ö—Ä–æ–º–∞—Ç–æ–∑ - –∏–∑–±–µ–≥–∞—Ç—å –¥–æ–±–∞–≤–æ–∫ –∂–µ–ª–µ–∑–∞!"),
                    "AG": ("carrier", "–ù–æ—Å–∏—Ç–µ–ª—å - –∫–æ–Ω—Ç—Ä–æ–ª—å —É—Ä–æ–≤–Ω—è —Ñ–µ—Ä—Ä–∏—Ç–∏–Ω–∞"),
                    "GG": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω—ã–π –º–µ—Ç–∞–±–æ–ª–∏–∑–º –∂–µ–ª–µ–∑–∞"),
                }
            },
            "rs855791": {
                "gene": "TMPRSS6",
                "description": "–£—Ä–æ–≤–µ–Ω—å –∂–µ–ª–µ–∑–∞",
                "interpretation": {
                    "TT": ("low", "–°–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –Ω–∏–∑–∫–æ–º—É –∂–µ–ª–µ–∑—É"),
                    "CT": ("moderate", "–£–º–µ—Ä–µ–Ω–Ω–æ —Å–Ω–∏–∂–µ–Ω"),
                    "AG": ("moderate", "–£–º–µ—Ä–µ–Ω–Ω–æ —Å–Ω–∏–∂–µ–Ω —É—Ä–æ–≤–µ–Ω—å"),
                    "CC": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å"),
                    "AA": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω—ã–π"),
                    "GG": ("normal", "–ù–æ—Ä–º–∞–ª—å–Ω—ã–π"),
                }
            },
        }
    },
}


def load_genome():
    """Load genome data into a dictionary"""
    genome = {}
    with open(GENOME_FILE, 'r') as f:
        for line in f:
            if line.startswith('#'):
                continue
            parts = line.strip().split('\t')
            if len(parts) >= 4:
                rsid, chrom, pos, genotype = parts[0], parts[1], parts[2], parts[3]
                genome[rsid] = {
                    'chromosome': chrom,
                    'position': pos,
                    'genotype': genotype
                }
    return genome


def analyze_nutrition(genome):
    """Analyze nutrition markers"""
    results = {}

    for category, cat_info in NUTRITION_SNPS.items():
        cat_results = []
        for snp_id, snp_info in cat_info['snps'].items():
            result = {
                'snp_id': snp_id,
                'gene': snp_info['gene'],
                'description': snp_info['description'],
                'found': False,
                'genotype': None,
                'status': None,
                'interpretation': None
            }

            if snp_id in genome:
                result['found'] = True
                genotype = genome[snp_id]['genotype']
                result['genotype'] = genotype

                interp = snp_info.get('interpretation', {})
                for gt in [genotype, genotype[::-1] if len(genotype) == 2 else genotype]:
                    if gt in interp:
                        result['status'], result['interpretation'] = interp[gt]
                        break

            cat_results.append(result)
        results[category] = cat_results

    return results


def generate_report(results):
    """Generate nutrition report"""
    report = []
    report.append("# ü•ó –ê–Ω–∞–ª–∏–∑ –ø–∏—Ç–∞–Ω–∏—è –∏ –º–µ—Ç–∞–±–æ–ª–∏–∑–º–∞")
    report.append(f"\n–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞: {datetime.now().strftime('%Y-%m-%d %H:%M')}")
    report.append("\n---\n")

    # Summary of key findings
    report.append("## üìã –ö–ª—é—á–µ–≤—ã–µ –Ω–∞—Ö–æ–¥–∫–∏\n")

    recommendations = []
    warnings = []

    for category, cat_results in results.items():
        for r in cat_results:
            if r['status'] in ['impaired', 'intolerant', 'slow', 'low', 'sensitive', 'high_risk', 'flush', 'severe']:
                warnings.append(f"‚ö†Ô∏è **{r['gene']}**: {r['interpretation']}")
            elif r['status'] in ['tolerant', 'fast', 'normal', 'low_risk']:
                pass  # Normal findings

    if warnings:
        report.append("### –¢—Ä–µ–±—É—é—Ç –≤–Ω–∏–º–∞–Ω–∏—è\n")
        for w in warnings:
            report.append(f"- {w}")
        report.append("")

    report.append("---\n")

    # Detailed results by category
    for category, cat_results in results.items():
        cat_name = NUTRITION_SNPS[category]['name']
        report.append(f"## {cat_name}\n")
        report.append("| SNP | –ì–µ–Ω | –ì–µ–Ω–æ—Ç–∏–ø | –°—Ç–∞—Ç—É—Å | –ò–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏—è |")
        report.append("|-----|-----|---------|--------|---------------|")

        for r in cat_results:
            if r['found']:
                status_emoji = {
                    'normal': '‚úÖ',
                    'tolerant': '‚úÖ',
                    'fast': '‚úÖ',
                    'low_risk': '‚úÖ',
                    'moderate': 'üü°',
                    'partial': 'üü°',
                    'medium': 'üü°',
                    'carrier': 'üü°',
                    'impaired': 'üî¥',
                    'intolerant': 'üî¥',
                    'slow': 'üî¥',
                    'low': 'üî¥',
                    'sensitive': 'üî¥',
                    'high_risk': 'üî¥',
                    'flush': 'üî¥',
                    'severe': 'üî¥',
                    'supertaster': '‚ÑπÔ∏è',
                    'non_taster': '‚ÑπÔ∏è',
                    'soap': '‚ÑπÔ∏è',
                }.get(r['status'], '‚Ä¢')
                interp = r['interpretation'] or '–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'
                status = r['status'] or '–Ω/–¥'
                report.append(f"| {r['snp_id']} | {r['gene']} | **{r['genotype']}** | {status_emoji} {status} | {interp} |")
            else:
                report.append(f"| {r['snp_id']} | {r['gene']} | - | - | –ù–µ –Ω–∞–π–¥–µ–Ω |")
        report.append("")

    # Recommendations section
    report.append("---\n")
    report.append("## üí° –ü–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏\n")

    # Generate recommendations based on findings
    rec_map = {
        'lactose': {
            'intolerant': "**–õ–∞–∫—Ç–æ–∑–∞**: –ò–∑–±–µ–≥–∞–π—Ç–µ –º–æ–ª–æ—á–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –±–µ–∑–ª–∞–∫—Ç–æ–∑–Ω—ã–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã",
            'partial': "**–õ–∞–∫—Ç–æ–∑–∞**: –£–º–µ—Ä–µ–Ω–Ω–æ–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ –º–æ–ª–æ—á–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª–∞–∫—Ç–∞–∑—É"
        },
        'caffeine': {
            'slow': "**–ö–æ—Ñ–µ–∏–Ω**: –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ 1-2 —á–∞—à–µ–∫ –∫–æ—Ñ–µ –≤ –¥–µ–Ω—å, –∏–∑–±–µ–≥–∞–π—Ç–µ –ø–æ—Å–ª–µ –æ–±–µ–¥–∞",
            'high_anxiety': "**–ö–æ—Ñ–µ–∏–Ω**: –ï—Å–ª–∏ –∏—Å–ø—ã—Ç—ã–≤–∞–µ—Ç–µ —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç—å –æ—Ç –∫–æ—Ñ–µ - —Å–Ω–∏–∑—å—Ç–µ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ"
        },
        'vitamin_d': {
            'low': "**–í–∏—Ç–∞–º–∏–Ω D**: –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∫–∞ 2000-4000 –ú–ï/–¥–µ–Ω—å, –æ—Å–æ–±–µ–Ω–Ω–æ –∑–∏–º–æ–π",
            'moderate': "**–í–∏—Ç–∞–º–∏–Ω D**: –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ —É—Ä–æ–≤–µ–Ω—å 25(OH)D, –≤–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–Ω–∞ –¥–æ–±–∞–≤–∫–∞"
        },
        'vitamin_b': {
            'impaired': "**–§–æ–ª–∞—Ç—ã**: –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –º–µ—Ç–∏–ª—Ñ–æ–ª–∞—Ç –≤–º–µ—Å—Ç–æ —Ñ–æ–ª–∏–µ–≤–æ–π –∫–∏—Å–ª–æ—Ç—ã (400-800 –º–∫–≥/–¥–µ–Ω—å)"
        },
        'vitamin_a': {
            'impaired': "**–í–∏—Ç–∞–º–∏–Ω A**: –ü–æ–ª—É—á–∞–π—Ç–µ –∏–∑ –∂–∏–≤–æ—Ç–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–ø–µ—á–µ–Ω—å, —è–π—Ü–∞) –∏–ª–∏ –¥–æ–±–∞–≤–æ–∫ —Ä–µ—Ç–∏–Ω–æ–ª–∞"
        },
        'omega3': {
            'impaired': "**–û–º–µ–≥–∞-3**: –£–ø–æ—Ç—Ä–µ–±–ª—è–π—Ç–µ –∂–∏—Ä–Ω—É—é —Ä—ã–±—É 2-3 —Ä–∞–∑–∞ –≤ –Ω–µ–¥–µ–ª—é –∏–ª–∏ –¥–æ–±–∞–≤–∫–∏ EPA/DHA"
        },
        'iron': {
            'high_risk': "**–ñ–µ–ª–µ–∑–æ**: –ò–ó–ë–ï–ì–ê–ô–¢–ï –¥–æ–±–∞–≤–æ–∫ –∂–µ–ª–µ–∑–∞! –†–µ–≥—É–ª—è—Ä–Ω–æ –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ —Ñ–µ—Ä—Ä–∏—Ç–∏–Ω",
            'low': "**–ñ–µ–ª–µ–∑–æ**: –í–æ–∑–º–æ–∂–Ω–∞ —Å–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –∞–Ω–µ–º–∏–∏ - –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–π—Ç–µ –≥–µ–º–æ–≥–ª–æ–±–∏–Ω –∏ —Ñ–µ—Ä—Ä–∏—Ç–∏–Ω"
        },
        'salt': {
            'sensitive': "**–°–æ–ª—å**: –û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ 5–≥/–¥–µ–Ω—å, –∏–∑–±–µ–≥–∞–π—Ç–µ –ø–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤"
        },
        'alcohol': {
            'flush': "**–ê–ª–∫–æ–≥–æ–ª—å**: –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–æ–ª–Ω—ã–π –æ—Ç–∫–∞–∑ - –ø–æ–≤—ã—à–µ–Ω —Ä–∏—Å–∫ —Ä–∞–∫–∞ –ø–∏—â–µ–≤–æ–¥–∞",
            'severe': "**–ê–ª–∫–æ–≥–æ–ª—å**: –ü–æ–ª–Ω—ã–π –æ—Ç–∫–∞–∑ –æ—Ç –∞–ª–∫–æ–≥–æ–ª—è"
        }
    }

    has_recommendations = False
    for category, cat_results in results.items():
        if category in rec_map:
            for r in cat_results:
                if r['status'] in rec_map[category]:
                    report.append(f"- {rec_map[category][r['status']]}")
                    has_recommendations = True

    if not has_recommendations:
        report.append("- –ù–µ—Ç –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –Ω–∞—Ö–æ–¥–æ–∫, –ø—Ä–∏–¥–µ—Ä–∂–∏–≤–∞–π—Ç–µ—Å—å —Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–∏—Ç–∞–Ω–∏—è")

    report.append("\n---\n")
    report.append("## ‚ö†Ô∏è –í–∞–∂–Ω–æ\n")
    report.append("- –ì–µ–Ω–µ—Ç–∏–∫–∞ ‚Äî —ç—Ç–æ –ø—Ä–µ–¥—Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–Ω–æ—Å—Ç—å, –Ω–µ –¥–∏–∞–≥–Ω–æ–∑")
    report.append("- –ü–µ—Ä–µ–¥ –ø—Ä–∏—ë–º–æ–º –¥–æ–±–∞–≤–æ–∫ –ø—Ä–æ–∫–æ–Ω—Å—É–ª—å—Ç–∏—Ä—É–π—Ç–µ—Å—å —Å –≤—Ä–∞—á–æ–º")
    report.append("- –î–ª—è –≤–∏—Ç–∞–º–∏–Ω–∞ D –∏ –∂–µ–ª–µ–∑–∞ —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–¥–∞—Ç—å –∞–Ω–∞–ª–∏–∑—ã –∫—Ä–æ–≤–∏")

    return '\n'.join(report)


def main():
    print("=" * 60)
    print("–ê–ù–ê–õ–ò–ó –ü–ò–¢–ê–ù–ò–Ø –ò –ú–ï–¢–ê–ë–û–õ–ò–ó–ú–ê")
    print("=" * 60)

    print("\n[1/3] –ó–∞–≥—Ä—É–∑–∫–∞ –≥–µ–Ω–æ–º–∞...")
    genome = load_genome()
    print(f"      –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(genome)} SNP")

    print("\n[2/3] –ê–Ω–∞–ª–∏–∑ –º–∞—Ä–∫–µ—Ä–æ–≤...")
    results = analyze_nutrition(genome)

    total = sum(len(r) for r in results.values())
    found = sum(sum(1 for x in r if x['found']) for r in results.values())
    print(f"      –ù–∞–π–¥–µ–Ω–æ: {found}/{total} –º–∞—Ä–∫–µ—Ä–æ–≤")

    print("\n[3/3] –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç—á—ë—Ç–∞...")
    report = generate_report(results)

    report_path = f"{REPORTS_PATH}/nutrition/report.md"
    with open(report_path, 'w', encoding='utf-8') as f:
        f.write(report)
    print(f"      ‚Üí {report_path}")

    print("\n" + "=" * 60)
    print("–ê–ù–ê–õ–ò–ó –ó–ê–í–ï–†–®–Å–ù")
    print("=" * 60)


if __name__ == "__main__":
    main()
